{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/Gatsby.jsでOGPイメージを表示するときハマったことメモ/","webpackCompilationHash":"b31ab5cef85b607ff3b3","result":{"data":{"site":{"siteMetadata":{"title":"Takumi Ogawa - @ogady","user":{"name":"Takumi Ogawa","github":"ogady","qiita":"ogady","twitter":"_ogady_","facebook":"takumi.ogawa.37266","linkedin":"takumi-ogawa-869046195"}}},"markdownRemark":{"html":"<h2>やりたかったこと</h2>\n<p>Gatsby.jsで作ったサイトにOGP設定をして、リンクシェアしたときにTwitterカードとかを綺麗に表示させたかった。</p>\n<h2>前提</h2>\n<ul>\n<li>静的サイトホスティングには、github pages を使用</li>\n<li>個人ドメインは使用ぜず、デフォルトの<code class=\"language-text\">https://{ユーザー名}.github.io/{リポジトリ名}</code>を使用</li>\n</ul>\n<h2>ハマったこと</h2>\n<p>Twitterカードにサムネイルがうまく表示されない。</p>\n<h2>調べてみる</h2>\n<p><code class=\"language-text\">gatsby-config.js</code> はこう</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> querystring <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> siteMetadata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  title<span class=\"token operator\">:</span> <span class=\"token string\">'Takumi Ogawa - @ogady'</span><span class=\"token punctuation\">,</span>\n  author<span class=\"token operator\">:</span> <span class=\"token string\">'Takumi Ogawa'</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">:</span> <span class=\"token string\">\"ogady's portfolio site\"</span><span class=\"token punctuation\">,</span>\n  siteUrl<span class=\"token operator\">:</span> <span class=\"token string\">'https://ogady.github.io/portfolio_site'</span><span class=\"token punctuation\">,</span>　\n  siteLanguage<span class=\"token operator\">:</span> <span class=\"token string\">'ja'</span><span class=\"token punctuation\">,</span>\n  shortName<span class=\"token operator\">:</span> <span class=\"token string\">'ogady'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>中略<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  siteMetadata<span class=\"token punctuation\">,</span>\n  pathPrefix<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/portfolio_site</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ←（1）</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-source-filesystem</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">images</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        path<span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">src</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">assets</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">images</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>　<span class=\"token comment\">// ← サムネイル画像の格納パス</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>（1）では、pathPrefixを指定しています。Github Pagesはドメインのルート（/）以外（<code class=\"language-text\">https://{ユーザー名}.github.io/{リポジトリ名}</code>）でホストされているので、すべてのリソースのパスにプレフィックス（{リポジトリ名}の部分）を追加する必要があります。</p>\n<p>ヘッダー情報のコンポーネントはこう</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-tsx line-numbers\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> Helmet<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> HelmetProps <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-helmet'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> graphql<span class=\"token punctuation\">,</span> useStaticQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'gatsby'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createAbsoluteUri <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../lib/utils'</span>\n\n<span class=\"token keyword\">const</span> Head<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">FC</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HelmetProps</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> = () => </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token function\">useStaticQuery</span><span class=\"token punctuation\">(</span>graphql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    {\n      site {\n        siteMetadata {\n          title\n          description\n          siteUrl\n          siteLanguage\n          user {\n            twitter\n          }\n        }\n      }\n      avatar: file(relativePath: { eq: \"ogady_pro.jpg\" }) { \t// ←（2）\n        publicURL\n      }\n    }\n  </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    user<span class=\"token punctuation\">,</span>\n    title<span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">,</span>\n    siteUrl<span class=\"token punctuation\">,</span>\n    siteLanguage<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>site<span class=\"token punctuation\">.</span>siteMetadata\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Helmet</span></span> <span class=\"token attr-name\">title</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>title<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>siteLanguage<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        ----------中略----------\n      &lt;meta\n        property=\"og:image\"\n        content=</span><span class=\"token punctuation\">{</span><span class=\"token function\">createAbsoluteUri</span><span class=\"token punctuation\">(</span>siteUrl<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">.</span>publicURL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"> // ←（3）\n      />\n        ----------中略----------\n      &lt;meta\n        name=\"twitter:image\"\n        content=</span><span class=\"token punctuation\">{</span><span class=\"token function\">createAbsoluteUri</span><span class=\"token punctuation\">(</span>siteUrl<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>avatar<span class=\"token punctuation\">.</span>publicURL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"> // ←（4）\n      />\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Helmet</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\nexport default Head</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>（2）では、graphQLのクエリでサムネイル画像のファイル名指定で、ファイルを静的ディレクトリにコピーし、パブリックURL（相対パス）を取得しています。</p>\n<p>（3）、（4）で<code class=\"language-text\">content</code>に指定したURLがOGPのカードにサムネイルとして表示されます。ここでは、siteMetadataで定義している<code class=\"language-text\">siteUrl</code>と①で取得したパブリックURLを結合してサムネイル画像のフルパスを生成しています。</p>\n<h2>何がダメだったか</h2>\n<p>（3）、（4）でsiteUrlと、サムネ画像の<code class=\"language-text\">publicURL</code>を結合していますが、siteURLにパスプレフィックスと同じリポジトリ名を含めてしまっていた。</p>\n<p><code class=\"language-text\">publicURL</code>には（1）で定義したパスプレフィックスが含まれるので、最終的なサムネイル画像のフルパスが</p>\n<p><code class=\"language-text\">https://{ユーザー名}.github.io/{リポジトリ名}/{リポジトリ名}/static/{サムネイル画像ファイル}</code>となってしまい、正しく参照されていなかった。</p>\n<h2>どうすべきか</h2>\n<p>直し方は簡単で、<code class=\"language-text\">gatsby-config.js</code>を以下のように編集する、</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> querystring <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> siteMetadata <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  title<span class=\"token operator\">:</span> <span class=\"token string\">'Takumi Ogawa - @ogady'</span><span class=\"token punctuation\">,</span>\n  author<span class=\"token operator\">:</span> <span class=\"token string\">'Takumi Ogawa'</span><span class=\"token punctuation\">,</span>\n  description<span class=\"token operator\">:</span> <span class=\"token string\">\"ogady's portfolio site\"</span><span class=\"token punctuation\">,</span> \n  <span class=\"token comment\">// siteUrl: 'https://ogady.github.io/portfolio_site',　// ここを↓</span>\n  siteUrl<span class=\"token operator\">:</span> <span class=\"token string\">'https://ogady.github.io'</span><span class=\"token punctuation\">,</span>　<span class=\"token comment\">// こう！！</span>\n  siteLanguage<span class=\"token operator\">:</span> <span class=\"token string\">'ja'</span><span class=\"token punctuation\">,</span>\n  shortName<span class=\"token operator\">:</span> <span class=\"token string\">'ogady'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>中略<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>後書き</h2>\n<p>くそ凡ミスでした。。。</p>\n<h2>参考にした記事など</h2>\n<ul>\n<li><a href=\"https://www.gatsbyjs.org/docs/path-prefix/\">公式ドキュメント</a></li>\n</ul>","frontmatter":{"title":"Gatsby.jsでOGPイメージを表示するときハマったことメモ","date":"11 January, 2020","tags":["Gatsby"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/Gatsby.jsでOGPイメージを表示するときハマったことメモ/"}}}